<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quran Reading Coordination</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
      color: #222;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    h2 {
      margin-top: 32px;
      margin-bottom: 16px;
      font-size: 1.4em;
      font-weight: 700;
    }

    .section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      margin-bottom: 32px;
      padding: 24px;
    }

    .portions-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin: 16px 0;
    }

    .portion-btn {
      background: #eaf0fa;
      border: 2px solid #cfd8e3;
      border-radius: 6px;
      padding: 12px 0;
      text-align: center;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
      position: relative;
    }

    .portion-btn.selected {
      background: #10b981;
      border-color: #059669;
      color: #fff;
    }

    .portion-btn.done {
      background: #10b981;
      border-color: #059669;
      color: #fff;
    }

    .portion-btn .icon {
      position: absolute;
      top: 4px;
      font-size: 1.1em;
      cursor: pointer;
      color: #555;
    }

    .portion-btn .icon.confirm {
      left: 4px;
      color: #4bbf73;
    }

    .portion-btn .icon.remove {
      right: 4px;
      color: #e57373;
    }

    .actions {
      margin-bottom: 12px;
    }

    .actions button {
      margin-right: 8px;
      padding: 6px 16px;
      border-radius: 4px;
      border: none;
      font-size: 1em;
      cursor: pointer;
      background: #eaf0fa;
      color: #222;
      transition: background 0.2s;
    }

    .actions button.selected {
      background: #4bbf73;
      color: #fff;
    }

    .actions button.clear {
      background: #e57373;
      color: #fff;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .color-option.selected {
      border-color: #fff;
      box-shadow: 0 0 0 2px #333, 0 4px 8px rgba(0,0,0,0.3);
      transform: scale(1.1);
    }

    .color-option.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    .summary-table,
    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .summary-table th,
    .summary-table td,
    .timeline-table th,
    .timeline-table td {
      border: 1px solid #cfd8e3;
      padding: 8px;
      text-align: left;
    }

    .summary-table th,
    .timeline-table th {
      background: #eaf0fa;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #eaf0fa;
      border-radius: 6px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: #4bbf73;
      border-radius: 6px;
      transition: width 0.3s;
    }

    @media (max-width: 600px) {
      .container {
        padding: 8px;
      }

      .section {
        padding: 12px;
      }

      .portions-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      /* Stack summary columns on mobile */
      #summary-section > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
      }


    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Quran Reading Coordination</h1>

    <!-- Brief Introduction Message -->
    <div class="section"
      style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="font-size: 2rem;">📖</div>
        <div>
          <h3 style="margin: 0; color: #0c4a6e; font-size: 1.2rem;">Welcome to Quran Reading Coordination</h3>
          <p style="margin: 4px 0 0 0; color: #075985; font-size: 0.95rem;">
            Coordinate your Quran reading journey with your study group. Select portions, track progress, and complete
            together.
          </p>
        </div>
      </div>
    </div>

    <div class="section" id="claim-section">
      <h2>Claim Your Quran Reading Portions (Juz/Para)</h2>
      <label for="participant-name">Your Name</label><br>
      <input type="text" id="participant-name" placeholder="Enter your full name"
        style="width:100%;margin-bottom:12px;padding:8px;">
      <div class="actions">
        <button id="select-all">Select All Available</button>
        <button id="clear-all" class="clear">Clear All</button>
      </div>

      <!-- Selection Summary -->
      <div id="selection-summary"
        style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin: 16px 0; text-align: center; color: #64748b; font-weight: 500;">
        No portions selected
      </div>

      <div class="portions-grid" id="portion-select-grid"></div>
      <label for="completion-date">Completion Date</label><br>
      <input type="date" id="completion-date" style="width:100%;margin-bottom:12px;padding:8px;">
      
      <label for="color-selector">Choose Your Color</label><br>
      <div id="color-selector" style="display: flex; gap: 8px; margin: 8px 0 16px 0; flex-wrap: wrap;">
        <div class="color-option" data-color="#3b82f6" style="background: #3b82f6;" title="Blue"></div>
        <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" title="Purple"></div>
        <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;" title="Amber"></div>
        <div class="color-option" data-color="#ef4444" style="background: #ef4444;" title="Red"></div>
        <div class="color-option" data-color="#06b6d4" style="background: #06b6d4;" title="Cyan"></div>
        <div class="color-option" data-color="#f97316" style="background: #f97316;" title="Orange"></div>
        <div class="color-option" data-color="#ec4899" style="background: #ec4899;" title="Pink"></div>
        <div class="color-option" data-color="#6366f1" style="background: #6366f1;" title="Indigo"></div>
      </div>
      <button id="claim-btn"
        style="background:#ffc66c;color:#222;padding:10px 24px;border-radius:6px;border:none;font-size:1.1em;">Claim
        Portion(s)</button>
      <div id="claim-message" style="margin-top:10px;color:#4bbf73;font-weight:500;"></div>
    </div>
  <div class="section" id="overview-section">
    <h2>Project Progress</h2>

    <!-- Claiming Progress Summary -->
    <div id="claiming-summary"
      style="background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border: 1px solid #bbf7d0; border-radius: 12px; padding: 20px; margin-bottom: 24px; display: none;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <div style="font-size: 1.5rem;">✨</div>
        <h3 style="margin: 0; color: #065f46; font-size: 1.1rem;">Claiming Progress</h3>
      </div>
      <div id="claiming-details" style="color: #047857; font-size: 0.95rem;"></div>
    </div>

    <div class="progress-bar">
      <div class="progress" id="progress-bar"></div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:24px;">
      <div>
        <div><b id="assigned-count">0</b> Portions Assigned</div>
        <div><b id="available-count">30</b> Available Portions</div>
        <div><b id="active-readers">0</b> Active Readers</div>
        <div>Est. Completion: <b id="est-completion">-</b></div>
      </div>
    </div>
    <h3 style="margin-top:24px;">Reading Portions Overview</h3>
    <div class="portions-grid" id="portion-overview-grid"></div>
  </div>
  <div class="section" id="summary-section">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
      
      <!-- Reader Assignments Column -->
      <div>
        <h2 style="text-align: center; color: #4f46e5; margin-bottom: 20px;">Reader Assignments</h2>
        <div id="reader-assignments-cards"></div>
      </div>
      
      <!-- Completion Timeline Column -->
      <div>
        <h2 style="text-align: center; color: #4f46e5; margin-bottom: 20px;">Completion Timeline</h2>
        <div id="timeline-cards"></div>
      </div>
      
    </div>
  </div>
  <script>
    // --- Firebase Configuration ---
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBmhnpfN8fDIo-w2Cux9Z24UM6Pef3DTrE",
      authDomain: "collaboration-6c1f9.firebaseapp.com",
      projectId: "collaboration-6c1f9",
      storageBucket: "collaboration-6c1f9.firebasestorage.app",
      messagingSenderId: "898101038569",
      appId: "1:898101038569:web:f820b57e92a42ebf848f78"
    };

    // Initialize Firebase with error handling
    let db;
    try {
      console.log('Initializing Firebase...');
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase app initialized');
      
      db = firebase.firestore();
      console.log('Firestore initialized');
      
      // Test connection
      db.enableNetwork().then(() => {
        console.log('Firestore network enabled');
      }).catch((error) => {
        console.warn('Firestore network error:', error);
      });
      
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Firebase initialization failed: ' + error.message);
    }
    
    const PROJECT_DOC = 'reading-coordination';

    // --- Data Model ---
    const PORTION_COUNT = 30;
    let currentData = null;
    let isLoading = false;

    function getDefaultData() {
      return {
        portions: Array(PORTION_COUNT).fill(null), // [{reader, date, done}]
        readers: {}, // {name: {portions: [], dates: []}}
        userColors: {}, // {userName: color}
        lastUpdated: new Date().toISOString()
      };
    }

    async function loadData() {
      if (isLoading) return currentData || getDefaultData();

      isLoading = true;
      try {
        console.log('Attempting to load data from Firestore...');
        
        if (!db) {
          throw new Error('Firestore not initialized');
        }
        
        const doc = await db.collection('projects').doc(PROJECT_DOC).get();
        console.log('Firestore document retrieved:', doc.exists);
        
        if (doc.exists) {
          currentData = doc.data();
          console.log('Data loaded from Firestore:', currentData);
          if (!currentData.portions || !currentData.readers) {
            currentData = getDefaultData();
          }
          // Load user colors from data
          if (currentData.userColors) {
            userColors = currentData.userColors;
          }
        } else {
          console.log('No existing document, creating default data');
          currentData = getDefaultData();
          await saveData(currentData);
        }
      } catch (error) {
        console.error('Error loading data from Firestore:', error.message);
        // Fallback to localStorage
        try {
          const localData = JSON.parse(localStorage.getItem('readingProjectData'));
          currentData = localData && localData.portions ? localData : getDefaultData();
          if (localData && localData.userColors) {
            userColors = localData.userColors;
          }
        } catch (e) {
          currentData = getDefaultData();
        }
      }
      isLoading = false;
      return currentData;
    }

    async function saveData(data) {
      data.lastUpdated = new Date().toISOString();
      data.userColors = userColors; // Save user colors
      currentData = data;

      try {
        if (db) {
          console.log('Saving data to Firestore...');
          await db.collection('projects').doc(PROJECT_DOC).set(data);
          console.log('Data saved to Firestore successfully');
        } else {
          console.warn('Firestore not available, saving to localStorage only');
        }
        // Also save to localStorage as backup
        localStorage.setItem('readingProjectData', JSON.stringify(data));
      } catch (error) {
        console.error('Error saving data to Firestore:', error);
        // Fallback to localStorage only
        localStorage.setItem('readingProjectData', JSON.stringify(data));
        throw error;
      }
    }

    // Real-time listener for data changes
    function setupRealtimeListener() {
      db.collection('projects').doc(PROJECT_DOC).onSnapshot((doc) => {
        if (doc.exists && !isLoading) {
          const newData = doc.data();
          if (newData.lastUpdated !== currentData?.lastUpdated) {
            currentData = newData;
            renderAll();
          }
        }
      }, (error) => {
        console.error('Error in realtime listener:', error);
      });
    }
    // --- UI State ---
    let selectedPortions = [];
    let clickCounts = {}; // Track clicks on locked portions for secret unlock
    let userColors = {}; // Track colors assigned to users
    let selectedColor = '#3b82f6'; // Default color (blue)

    // Available colors for users (excluding green which is for completed)
    const availableColors = [
      '#3b82f6', // Blue
      '#8b5cf6', // Purple
      '#f59e0b', // Amber
      '#ef4444', // Red
      '#06b6d4', // Cyan
      '#84cc16', // Lime
      '#f97316', // Orange
      '#ec4899', // Pink
      '#6366f1', // Indigo
      '#14b8a6', // Teal
      '#a855f7', // Violet
      '#eab308', // Yellow
      '#dc2626', // Red-600
      '#7c3aed', // Violet-600
      '#0891b2', // Cyan-600
      '#ca8a04', // Yellow-600
    ];

    function getUserColor(userName) {
      if (!userColors[userName]) {
        // Find next available color
        const usedColors = Object.values(userColors);
        const availableColor = availableColors.find(color => !usedColors.includes(color));
        userColors[userName] = availableColor || availableColors[Object.keys(userColors).length % availableColors.length];
      }
      return userColors[userName];
    }

    // Robust reload function for mobile compatibility
    function forceReload(delay = 1000) {
      setTimeout(() => {
        // For mobile browsers, try multiple approaches
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
          // Mobile-specific reload approach
          try {
            // Method 1: Create a temporary form and submit it (works well on mobile)
            const form = document.createElement('form');
            form.method = 'GET';
            form.action = window.location.href;
            document.body.appendChild(form);
            form.submit();
            return;
          } catch (formError) {
            // Continue to other methods if form submission fails
          }
        }

        // Standard reload methods
        try {
          window.location.reload(true);
        } catch (e1) {
          try {
            window.location.reload();
          } catch (e2) {
            try {
              window.location.replace(window.location.href);
            } catch (e3) {
              try {
                window.location.assign(window.location.href);
              } catch (e4) {
                // Last resort - direct href assignment
                window.location.href = window.location.href + '?t=' + Date.now();
              }
            }
          }
        }
      }, delay);
    }

    function showLoading(show = true) {
      const existingLoader = document.getElementById('loading-indicator');
      if (show && !existingLoader) {
        const loader = document.createElement('div');
        loader.id = 'loading-indicator';
        loader.style.cssText = 'position:fixed;top:10px;right:10px;background:#4bbf73;color:white;padding:8px 16px;border-radius:4px;z-index:1000;';
        loader.textContent = 'Syncing...';
        document.body.appendChild(loader);
      } else if (!show && existingLoader) {
        existingLoader.remove();
      }
    }

    function renderPortionSelectGrid(data) {
      const grid = document.getElementById('portion-select-grid');
      grid.innerHTML = '';
      for (let i = 0; i < PORTION_COUNT; i++) {
        const portion = data.portions[i];
        const btn = document.createElement('div');
        btn.className = 'portion-btn' + (selectedPortions.includes(i) ? ' selected' : '') + (portion ? ' disabled' : '');
        btn.textContent = i + 1;
        btn.onclick = () => {
          if (portion) return;
          if (selectedPortions.includes(i)) {
            selectedPortions = selectedPortions.filter(p => p !== i);
          } else {
            selectedPortions.push(i);
          }
          renderPortionSelectGrid(data);
          updateSelectionSummary(); // Update selection summary
        };
        if (portion) {
          btn.style.opacity = 0.5;
          btn.title = `Claimed by ${portion.reader}`;
        }
        grid.appendChild(btn);
      }
      updateSelectionSummary(); // Update selection summary
    }

    function updateSelectionSummary() {
      const summaryEl = document.getElementById('selection-summary');
      if (!summaryEl) return; // Exit if element doesn't exist
      
      if (selectedPortions.length === 0) {
        summaryEl.innerHTML = 'No portions selected';
        summaryEl.style.background = '#f8fafc';
        summaryEl.style.borderColor = '#cbd5e1';
        summaryEl.style.color = '#64748b';
      } else {
        const sortedPortions = [...selectedPortions].sort((a, b) => a - b).map(i => i + 1);
        summaryEl.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span style="font-size: 1.2rem;">📋</span>
            <span><strong>${selectedPortions.length}</strong> portion${selectedPortions.length > 1 ? 's' : ''} selected: ${sortedPortions.join(', ')}</span>
          </div>
        `;
        summaryEl.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%)';
        summaryEl.style.borderColor = '#10b981';
        summaryEl.style.color = '#065f46';
      }
    }
    function renderPortionOverviewGrid(data) {
      const grid = document.getElementById('portion-overview-grid');
      grid.innerHTML = '';
      for (let i = 0; i < PORTION_COUNT; i++) {
        const portion = data.portions[i];
        const btn = document.createElement('div');
        btn.className = 'portion-btn' + (portion ? ' selected' : '');
        btn.innerHTML = `<div>${i + 1}</div>`;
        if (portion) {
          // Show name and date
          const info = document.createElement('div');
          info.style.fontSize = '0.8em';
          info.style.marginTop = '2px';
          info.style.color = '#222';
          info.textContent = `${portion.reader} (${portion.date})`;
          btn.appendChild(info);
          // Confirm icon
          const confirmIcon = document.createElement('span');
          confirmIcon.className = 'icon confirm';
          confirmIcon.innerHTML = '✔️';
          confirmIcon.title = 'Mark as done';
          confirmIcon.onclick = async (e) => {
            e.stopPropagation();
            showLoading();
            try {
              portion.done = !portion.done;
              await saveData(data);
              // Force reload for both desktop and mobile browsers
              forceReload(1000);
            } catch (error) {
              alert('Failed to update. Please try again.');
              portion.done = !portion.done; // Revert
              showLoading(false);
            }
          };
          btn.appendChild(confirmIcon);
          // Trash bin icon
          const removeIcon = document.createElement('span');
          removeIcon.className = 'icon remove';
          removeIcon.innerHTML = '🗑️';
          removeIcon.title = 'Remove from reader';
          removeIcon.onclick = async (e) => {
            e.stopPropagation();
            if (!confirm('Remove this assignment?')) return;
            showLoading();
            try {
              data.portions[i] = null;
              await saveData(data);
              // Force reload for both desktop and mobile browsers
              forceReload(1000);
            } catch (error) {
              alert('Failed to remove assignment. Please try again.');
              data.portions[i] = portion; // Revert
              showLoading(false);
            }
          };
          // Only show remove icon if portion is not completed
          if (!portion.done) {
            btn.appendChild(removeIcon);
          }

          if (portion.done) {
            btn.classList.add('done');
            // Completed portions are green
            btn.style.backgroundColor = '#10b981';
            btn.style.borderColor = '#059669';
            btn.style.color = '#fff';
            btn.title = `${portion.reader} - COMPLETED (${portion.date || '-'}) - Click 5 times to unlock`;

            // Secret unlock: 5 clicks to unlock completed portion
            btn.style.cursor = 'pointer';
            btn.onclick = (e) => {
              e.stopPropagation();
              const portionKey = `portion-${i}`;
              clickCounts[portionKey] = (clickCounts[portionKey] || 0) + 1;

              if (clickCounts[portionKey] >= 5) {
                if (confirm(`Unlock completed portion ${i + 1}? This will mark it as incomplete.`)) {
                  portion.done = false;
                  saveData(data).then(() => {
                    forceReload(500);
                  }).catch(() => {
                    alert('Failed to unlock portion. Please try again.');
                  });
                }
                clickCounts[portionKey] = 0; // Reset counter
              } else {
                // Visual feedback for clicks
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                  btn.style.transform = 'scale(1)';
                }, 100);
              }
            };
          } else {
            // Use user's assigned color for claimed but not completed portions
            const userColor = getUserColor(portion.reader);
            btn.style.backgroundColor = userColor;
            btn.style.borderColor = userColor;
            btn.style.color = '#fff';
            btn.title = `${portion.reader} (Due: ${portion.date || '-'})`;
          }
        } else {
          btn.title = 'Available';
        }
        grid.appendChild(btn);
      }
    }
    function renderProgress(data) {
      const assigned = data.portions.filter(p => p).length;
      const completed = data.portions.filter(p => p && p.done).length;
      const available = PORTION_COUNT - assigned;
      const readers = Object.keys(data.readers).length;

      const assignedEl = document.getElementById('assigned-count');
      const availableEl = document.getElementById('available-count');
      const readersEl = document.getElementById('active-readers');
      
      if (assignedEl) assignedEl.textContent = assigned;
      if (availableEl) availableEl.textContent = available;
      if (readersEl) readersEl.textContent = readers;

      // Update claiming summary
      const claimingSummary = document.getElementById('claiming-summary');
      const claimingDetails = document.getElementById('claiming-details');

      if (claimingSummary && claimingDetails) {
        if (assigned > 0) {
          claimingSummary.style.display = 'block';
          claimingDetails.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
              <div>
                <div style="font-size: 1.5rem; font-weight: 600; color: #059669;">${assigned}</div>
                <div style="font-size: 0.85rem;">Claimed</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;">${completed}</div>
                <div style="font-size: 0.85rem;">Completed</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 600; color: #6b7280;">${available}</div>
                <div style="font-size: 0.85rem;">Available</div>
              </div>
            </div>
          `;
        } else {
          claimingSummary.style.display = 'none';
        }
      }

      // Completion date
      let estDate = '-';
      if (assigned === PORTION_COUNT) {
        estDate = data.portions.reduce((max, p) => p && p.date && p.date > max ? p.date : max, '');
        let topDate = document.getElementById('top-completion-date');
        if (!topDate) {
          topDate = document.createElement('div');
          topDate.id = 'top-completion-date';
          topDate.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
          topDate.style.padding = '16px';
          topDate.style.borderRadius = '12px';
          topDate.style.fontWeight = 'bold';
          topDate.style.fontSize = '1.2em';
          topDate.style.marginBottom = '16px';
          topDate.style.textAlign = 'center';
          topDate.style.color = '#92400e';
          topDate.style.border = '2px solid #f59e0b';
          document.querySelector('.container').insertBefore(topDate, document.querySelector('.container').firstChild.nextSibling);
        }
        topDate.innerHTML = `🎉 <strong>All Portions Assigned!</strong> Overall Completion Date: ${estDate}`;
      } else {
        const topDate = document.getElementById('top-completion-date');
        if (topDate) topDate.remove();
      }
      const estCompletionEl = document.getElementById('est-completion');
      const progressBarEl = document.getElementById('progress-bar');
      
      if (estCompletionEl) estCompletionEl.textContent = estDate;
      if (progressBarEl) progressBarEl.style.width = (assigned / PORTION_COUNT * 100) + '%';
    }
    function renderReaderSummary(data) {
      const container = document.getElementById('reader-assignments-cards');
      if (!container) return; // Exit if element doesn't exist
      
      container.innerHTML = '';
      const readers = {};
      data.portions.forEach((p, idx) => {
        if (p) {
          if (!readers[p.reader]) readers[p.reader] = [];
          readers[p.reader].push({ portion: idx + 1, date: p.date, done: p.done });
        }
      });

      if (Object.keys(readers).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No assignments yet</div>';
        return;
      }

      Object.entries(readers).forEach(([reader, portions]) => {
        const userColor = getUserColor(reader);
        const latestDate = portions.reduce((max, p) => p.date && p.date > max ? p.date : max, '');
        const completedCount = portions.filter(p => p.done).length;

        const card = document.createElement('div');
        card.style.cssText = `
          background: #f8fafc; 
          border-radius: 8px; 
          padding: 16px; 
          margin-bottom: 12px; 
          border-left: 4px solid ${userColor};
        `;

        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="background: ${userColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
              ${reader}
            </div>
          </div>
          <div style="font-size: 0.9rem; color: #374151; margin-bottom: 4px;">
            <strong>Portions:</strong> ${portions.map(p => p.portion).join(', ')}
          </div>
          <div style="font-size: 0.85rem; color: #6b7280;">
            Latest completion: ${latestDate || 'Not set'} • ${completedCount}/${portions.length} completed
          </div>
        `;

        container.appendChild(card);
      });
    }
    function renderTimeline(data) {
      const container = document.getElementById('timeline-cards');
      if (!container) return; // Exit if element doesn't exist
      
      container.innerHTML = '';
      const byDate = {};
      data.portions.forEach((p, idx) => {
        if (p && p.date) {
          if (!byDate[p.date]) byDate[p.date] = [];
          byDate[p.date].push({ portion: idx + 1, reader: p.reader });
        }
      });

      if (Object.keys(byDate).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No deadlines set</div>';
        return;
      }

      Object.entries(byDate).sort().forEach(([date, portions]) => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: #f8fafc; 
          border-radius: 8px; 
          padding: 16px; 
          margin-bottom: 12px; 
          border-left: 4px solid #4f46e5;
        `;

        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div style="background: #4f46e5; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
              ${date}
            </div>
          </div>
          <div style="font-size: 0.9rem; color: #374151;">
            <strong>${portions.length}</strong> portion${portions.length > 1 ? 's' : ''}
          </div>
          <div style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">
            ${portions.map(p => `${p.portion}(${p.reader})`).join(', ')}
          </div>
        `;

        container.appendChild(card);
      });
    }
    async function renderAll() {
      const data = await loadData();
      renderPortionSelectGrid(data);
      renderPortionOverviewGrid(data);
      renderProgress(data);
      renderReaderSummary(data);
      renderTimeline(data);
    }
    // Color selector functionality
    function initializeColorSelector() {
      const colorOptions = document.querySelectorAll('.color-option');
      
      // Set default selection
      if (colorOptions.length > 0) {
        colorOptions[0].classList.add('selected');
      }
      
      colorOptions.forEach(option => {
        option.onclick = () => {
          // Remove previous selection
          colorOptions.forEach(opt => opt.classList.remove('selected'));
          // Add selection to clicked option
          option.classList.add('selected');
          selectedColor = option.dataset.color;
        };
      });
    }

    // --- Event Handlers ---
    document.getElementById('select-all').onclick = async () => {
      const data = await loadData();
      selectedPortions = [];
      for (let i = 0; i < PORTION_COUNT; i++) {
        if (!data.portions[i]) selectedPortions.push(i);
      }
      renderPortionSelectGrid(data);
    };

    document.getElementById('clear-all').onclick = async () => {
      selectedPortions = [];
      const data = await loadData();
      renderPortionSelectGrid(data);
    };

    document.getElementById('claim-btn').onclick = async () => {
      const name = document.getElementById('participant-name').value.trim();
      const date = document.getElementById('completion-date').value;
      const messageEl = document.getElementById('claim-message');

      if (!name) {
        messageEl.textContent = 'Please enter your name.';
        messageEl.style.color = '#e57373';
        return;
      }
      if (!date) {
        messageEl.textContent = 'Please enter a completion date.';
        messageEl.style.color = '#e57373';
        return;
      }
      if (selectedPortions.length === 0) {
        messageEl.textContent = 'Please select at least one portion.';
        messageEl.style.color = '#e57373';
        return;
      }

      showLoading();
      try {
        const data = await loadData();

        // Check if any selected portions are now taken
        const conflictPortions = selectedPortions.filter(idx => data.portions[idx]);
        if (conflictPortions.length > 0) {
          messageEl.textContent = `Portions ${conflictPortions.map(i => i + 1).join(', ')} were just claimed by someone else. Please refresh and try again.`;
          messageEl.style.color = '#e57373';
          showLoading(false);
          return;
        }

        // Assign selected color to user
        userColors[name] = selectedColor;

        selectedPortions.forEach(idx => {
          data.portions[idx] = { reader: name, date: date, done: false };
        });

        if (!data.readers[name]) data.readers[name] = { portions: [], dates: [] };
        data.readers[name].portions = data.portions
          .map((p, i) => p && p.reader === name ? i + 1 : null)
          .filter(x => x);
        data.readers[name].dates = data.portions
          .map((p, i) => p && p.reader === name ? p.date : null)
          .filter(x => x);

        await saveData(data);
        selectedPortions = [];
        messageEl.textContent = 'Portion(s) claimed successfully! Refreshing page...';
        messageEl.style.color = '#4bbf73';

        // Clear form
        document.getElementById('participant-name').value = '';
        document.getElementById('completion-date').value = '';

        // Force reload for both desktop and mobile browsers
        forceReload(1500);

      } catch (error) {
        messageEl.textContent = 'Failed to claim portions. Please try again.';
        messageEl.style.color = '#e57373';
      }
      showLoading(false);
    };
    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', async () => {
      showLoading();
      
      // Check if Firebase is available
      if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded');
        alert('Firebase SDK failed to load. Please check your internet connection.');
        showLoading(false);
        return;
      }
      
      try {
        console.log('Starting app initialization...');
        await renderAll();
        initializeColorSelector();
        
        if (db) {
          setupRealtimeListener();
          console.log('App initialized successfully with Firebase');
        } else {
          console.warn('Firebase not available, running in offline mode');
        }
      } catch (error) {
        console.error('Failed to load initial data:', error);
        alert('Failed to connect to database. Using offline mode. Error: ' + error.message);
      }
      showLoading(false);
    });
  </script>
</body>

</html>